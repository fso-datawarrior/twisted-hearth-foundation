name: Deploy to Production

on:
  pull_request:
    branches: [ main ]     # PRs into main -> PREVIEW deploy (Path A)
  push:
    branches: [ main ]     # Push to main -> PRODUCTION deploy (Path A)
  workflow_dispatch:       # Manual runs for Path B (deploy any branch to prod)
    inputs:
      branch:
        description: 'Branch to build/deploy (e.g., 3.1.0-dev-email-cleanup)'
        required: true
        default: 'main'
      target:
        description: 'preview or production'
        required: true
        default: 'preview'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      checks: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build project
        run: npm run build

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy to Firebase Hosting
        run: |
          firebase use twisted-hearth-foundation
          if [ "${{ github.event_name }}" = "pull_request" ] || [ "${{ inputs.target }}" = "preview" ]; then
            firebase hosting:channel:deploy pr-${{ github.event.number || 'manual' }} --expires 7d
          else
            echo "ðŸš€ Deploying to PRODUCTION..."
            firebase deploy --only hosting
            echo "âœ… Production deployment complete!"
          fi
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
