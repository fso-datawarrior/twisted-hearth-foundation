# Task 1 â€” Enhanced Supabase Auth + Persistence (v1.0.1)

## Current Status Assessment âœ…

**GOOD NEWS**: Most of the authentication infrastructure is already implemented and working! This task focuses on **enhancing** the existing system rather than building from scratch.

### What's Already Working
- âœ… Supabase client configured with proper auth settings
- âœ… AuthProvider with session persistence and auto-refresh
- âœ… Magic link authentication flow
- âœ… AuthModal component for login UX
- âœ… Discussion page already requires authentication
- âœ… Party date centralized in `src/lib/event.ts` (Oct 18, 2025)
- âœ… AuthCallback page for handling magic link redirects

---

## What We'll Enhance

* **Expand auth requirements** to RSVP and Gallery pages
* **Improve session management** with party-end auto-logout
* **Add RequireAuth component** for cleaner auth gating
* **Enhance AuthModal** with better error handling
* **Add OAuth providers** (Google, Apple) as optional
* **Improve auth state management** across the app

---

## 1) Enhance Party Configuration

**Update `src/lib/event.ts`** to include party end time:

```ts
export const EVENT = {
  // Local time for the party start
  startISO: "2025-10-18T19:00:00-06:00", // America/Denver is UTC-6 on this date
  // Add party end time (3am next day to cover "witching hour")
  endISO: "2025-10-19T03:00:00-06:00",
  timezone: "America/Denver",
  title: "The Ruths' Twisted Fairytale Halloween Bash",
};

// Add helper function for party end check
export function isPartyOver(): boolean {
  return new Date() > new Date(EVENT.endISO);
}
```

---

## 2) Enhance AuthProvider with Auto-Logout

**Update `src/lib/auth.tsx`** to add party-end auto-logout:

```tsx
// Add to existing AuthProvider useEffect
useEffect(() => {
  // Auto sign-out after party ends
  const checkPartyEnd = () => {
    if (isPartyOver()) {
      console.log('ðŸŽ‰ Party is over! Auto-signing out...');
      supabase.auth.signOut();
    }
  };

  // Check immediately
  checkPartyEnd();

  // Check every minute
  const interval = setInterval(checkPartyEnd, 60_000);
  
  return () => clearInterval(interval);
}, []);
```

---

## 3) Create RequireAuth Component

**Create `src/components/RequireAuth.tsx`**:

```tsx
import { useAuth } from '@/lib/auth';
import { AuthModal } from '@/components/AuthModal';
import { useState } from 'react';

interface RequireAuthProps {
  children: React.ReactNode;
  fallback?: React.ReactNode;
}

export default function RequireAuth({ children, fallback }: RequireAuthProps) {
  const { user, loading } = useAuth();
  const [showAuthModal, setShowAuthModal] = useState(false);

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[200px]">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-[--accent-gold]"></div>
      </div>
    );
  }

  if (!user) {
    if (fallback) {
      return <>{fallback}</>;
    }
    
    return (
      <div className="max-w-md mx-auto my-10 p-6 rounded-2xl shadow-lg bg-black/70 text-white">
        <h2 className="text-xl font-semibold mb-3">Please sign in to continue</h2>
        <p className="mb-4 text-[--ink]/80">
          This feature requires authentication to ensure a personalized experience.
        </p>
        <button
          onClick={() => setShowAuthModal(true)}
          className="w-full rounded-xl px-4 py-2 bg-emerald-600 hover:bg-emerald-500 transition-colors"
        >
          Sign In
        </button>
        <AuthModal 
          isOpen={showAuthModal} 
          onClose={() => setShowAuthModal(false)} 
        />
      </div>
    );
  }

  return <>{children}</>;
}
```

---

## 4) Add Auth Requirements to Key Pages

### RSVP Page
**Update `src/pages/RSVP.tsx`**:

```tsx
import RequireAuth from '@/components/RequireAuth';
// ... existing imports

const RSVP = () => {
  // ... existing component logic

  return (
    <RequireAuth>
      {/* Existing RSVP form content */}
    </RequireAuth>
  );
};
```

### Gallery Page  
**Update `src/pages/Gallery.tsx`**:

```tsx
import RequireAuth from '@/components/RequireAuth';
// ... existing imports

const Gallery = () => {
  // ... existing component logic

  return (
    <RequireAuth>
      {/* Existing gallery content */}
    </RequireAuth>
  );
};
```

---

## 5) Enhance AuthModal with Better UX

**Update `src/components/AuthModal.tsx`** to add:

```tsx
// Add these features to existing AuthModal:
// - Better error handling for expired links
// - Success state after magic link sent
// - OAuth provider buttons (optional)
// - Improved loading states
// - Better accessibility

// Example enhancement:
const [authState, setAuthState] = useState<'form' | 'sent' | 'error'>('form');
const [errorMessage, setErrorMessage] = useState<string | null>(null);

// Add OAuth providers section (optional)
const handleGoogleSignIn = async () => {
  const { error } = await supabase.auth.signInWithOAuth({
    provider: 'google',
    options: { redirectTo: `${window.location.origin}/auth` }
  });
  if (error) setErrorMessage(error.message);
};
```

---

## 6) Add OAuth Providers (Optional)

**Supabase Dashboard Configuration**:
1. Go to Authentication â†’ Providers
2. Enable Google, Apple, or other OAuth providers
3. Configure redirect URLs for your domains

**Update AuthModal** to include OAuth buttons:

```tsx
// Add OAuth section to AuthModal
<div className="space-y-3">
  <button
    onClick={handleGoogleSignIn}
    className="w-full flex items-center justify-center gap-2 px-4 py-2 border border-white/20 rounded-lg hover:bg-white/10 transition-colors"
  >
    <GoogleIcon className="w-4 h-4" />
    Continue with Google
  </button>
  
  <div className="relative">
    <div className="absolute inset-0 flex items-center">
      <span className="w-full border-t border-white/20" />
    </div>
    <div className="relative flex justify-center text-xs uppercase">
      <span className="bg-black px-2 text-[--ink]/60">Or</span>
    </div>
  </div>
</div>
```

---

## 7) Update Navigation for Auth State

**Update `src/components/NavBar.tsx`** to show user state:

```tsx
// Add user menu or sign-in button based on auth state
const { user, signOut } = useAuth();

// In the nav bar JSX:
{user ? (
  <div className="flex items-center gap-2">
    <span className="text-sm text-[--ink]/80">
      {user.email}
    </span>
    <button
      onClick={signOut}
      className="text-sm text-[--ink]/60 hover:text-[--ink] transition-colors"
    >
      Sign Out
    </button>
  </div>
) : (
  <button
    onClick={() => setShowAuthModal(true)}
    className="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg transition-colors"
  >
    Sign In
  </button>
)}
```

---

## 8) Testing Checklist

- [ ] **Magic link flow**: Email arrives, clicking link logs user in
- [ ] **Session persistence**: Refreshing page keeps user signed in
- [ ] **RSVP protection**: Shows auth prompt when not signed in
- [ ] **Gallery protection**: Shows auth prompt when not signed in
- [ ] **Discussion still works**: Existing auth flow continues working
- [ ] **Auto-logout**: After Oct 19, 2025 3:00 AM MT, users auto-sign-out
- [ ] **OAuth flow**: Google/Apple sign-in works (if enabled)
- [ ] **Error handling**: Expired links show appropriate messages
- [ ] **Mobile UX**: AuthModal works well on mobile devices

---

## 9) Environment Variables

**Ensure these are set in your `.env`**:

```env
VITE_SUPABASE_URL=your-supabase-url
VITE_SUPABASE_ANON_KEY=your-supabase-anon-key
```

**For OAuth (optional)**:
```env
VITE_GOOGLE_CLIENT_ID=your-google-client-id
VITE_APPLE_CLIENT_ID=your-apple-client-id
```

---

## 10) Database RLS Policies

**Ensure these policies exist in Supabase**:

```sql
-- RSVPs table
CREATE POLICY "Users can insert their own RSVPs" ON rsvps
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can view their own RSVPs" ON rsvps
  FOR SELECT USING (auth.uid() = user_id);

-- Guestbook posts table  
CREATE POLICY "Authenticated users can insert posts" ON guestbook_posts
  FOR INSERT WITH CHECK (auth.uid() IS NOT NULL);

CREATE POLICY "Anyone can view posts" ON guestbook_posts
  FOR SELECT USING (true);
```

---

## Ready for Task 2?

Once this enhanced auth system is working smoothly, we can move on to **Scavenger Hunt persistence + floating progress bar + Easter Egg modal** and wire it to Supabase so progress survives reloads and device switches.

The key improvements in this version:
1. **Builds on existing working auth** instead of replacing it
2. **Adds party-end auto-logout** for security
3. **Provides RequireAuth component** for cleaner page protection
4. **Includes OAuth options** for better UX
5. **Better error handling** and user feedback
6. **Maintains existing functionality** while adding new features
